<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vencimiento Zen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container {
            transition: all 0.3s ease-in-out;
        }
        .product-card {
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fdf8f0;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-[#FFFBF5]">

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-gray-700">Vencimiento Zen</h1>
            <p class="text-gray-500 mt-2">Tu asistente para evitar el desperdicio.</p>
        </header>

        <main>
            <div id="auth-container" class="text-center p-4">
                <p class="text-gray-600">Cargando...</p>
                <div id="auth-forms" class="hidden mt-4">
                    <form id="login-form" class="space-y-4 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Iniciar Sesión</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-600">Correo Electrónico</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-600">Contraseña</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg">
                        </div>
                        <button type="submit" class="w-full bg-[#A8D8B9] text-white text-lg font-bold py-3 px-4 rounded-xl hover:bg-[#97C6A8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#A8D8B9] shadow-md transition-transform transform hover:scale-105">
                            Iniciar Sesión
                        </button>
                    </form>
                    <button id="toggle-register" class="mt-4 text-gray-500 text-sm hover:underline">¿No tienes una cuenta? Regístrate</button>
                    
                    <form id="register-form" class="hidden space-y-4 bg-white p-6 rounded-2xl shadow-lg mt-4">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Registrarse</h2>
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-600">Correo Electrónico</label>
                            <input type="email" id="register-email" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-600">Contraseña</label>
                            <input type="password" id="register-password" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg">
                        </div>
                        <button type="submit" class="w-full bg-[#A8D8B9] text-white text-lg font-bold py-3 px-4 rounded-xl hover:bg-[#97C6A8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#A8D8B9] shadow-md transition-transform transform hover:scale-105">
                            Registrarse
                        </button>
                    </form>
                    <button id="toggle-login" class="hidden mt-4 text-gray-500 text-sm hover:underline">¿Ya tienes una cuenta? Iniciar Sesión</button>
                </div>
            </div>

            <div id="app-container" class="hidden">
                <div class="form-container bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Agregar un nuevo producto</h2>
                    <form id="product-form" class="space-y-4">
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-600">Nombre del Producto</label>
                            <input type="text" id="product-name" name="product-name" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg" placeholder="Ej: Leche, Huevos...">
                        </div>
                        <div>
                            <label for="expiry-date" class="block text-sm font-medium text-gray-600">Fecha de Vencimiento</label>
                            <input type="date" id="expiry-date" name="expiry-date" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-[#A8D8B9] focus:border-[#A8D8B9] text-lg">
                        </div>
                        <button type="submit" class="w-full bg-[#A8D8B9] text-white text-lg font-bold py-3 px-4 rounded-xl hover:bg-[#97C6A8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#A8D8B9] shadow-md transition-transform transform hover:scale-105">
                            Guardar Producto
                        </button>
                    </form>
                </div>

                <div class="mt-10">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Mis Productos</h2>
                    <div id="product-list" class="space-y-4">
                        <!-- Products will be dynamically inserted here -->
                    </div>
                     <div id="empty-state" class="hidden text-center py-10 px-6 bg-gray-50 rounded-2xl">
                        <p class="text-gray-500">¡Todo en orden! Aún no tienes productos registrados.</p>
                        <p class="text-gray-400 text-sm mt-2">Usa el formulario de arriba para empezar.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **PASO 1: PEGA TU CONFIGURACIÓN DE FIREBASE AQUÍ**
        // La obtuviste de la consola de Firebase al crear tu proyecto.
        const firebaseConfig = {
          apiKey: "AIzaSyCLoaKZlyatM69AHq0ivJW2lkpFUaTSAQA",
          authDomain: "vencimiento-zen-app.firebaseapp.com",
          projectId: "vencimiento-zen-app",
          storageBucket: "vencimiento-zen-app.firebasestorage.app",
          messagingSenderId: "887940198148",
          appId: "1:887940198148:web:1c4b9bba89aac75377ea51",
          measurementId: "G-MN8ZEZJ6RD"
        };
        
        // El appId para Firestore debe ser un valor único.
        const appId = "vencimiento-zen-app";

        let app;
        let auth;
        let db;

        const authContainer = document.getElementById('auth-container');
        const authForms = document.getElementById('auth-forms');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleRegisterBtn = document.getElementById('toggle-register');
        const toggleLoginBtn = document.getElementById('toggle-login');
        const appContainer = document.getElementById('app-container');
        const productForm = document.getElementById('product-form');
        const productNameInput = document.getElementById('product-name');
        const expiryDateInput = document.getElementById('expiry-date');
        const productList = document.getElementById('product-list');
        const emptyState = document.getElementById('empty-state');
        
        let currentUserId = null;
        let productsCollectionRef = null;
        let unsubscribe = null;

        async function initializeAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        currentUserId = user.uid;
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        setupRealtimeListener();
                    } else {
                        currentUserId = null;
                        appContainer.classList.add('hidden');
                        authContainer.classList.remove('hidden');
                        authContainer.querySelector('p').textContent = "";
                        authForms.classList.remove('hidden');
                        if (unsubscribe) {
                            unsubscribe();
                        }
                    }
                });

            } catch (error) {
                console.error("Authentication failed:", error);
                authContainer.querySelector('p').textContent = "Error de conexión. Por favor, revisa la consola para más detalles.";
            }
        }
        
        function setupRealtimeListener() {
            if (!currentUserId) return;

            productsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/products`);
            const q = query(productsCollectionRef);

            if (unsubscribe) {
                unsubscribe();
            }
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                products.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

                renderProducts(products);
            });
        }

        function calculateStatus(expiryDateStr) {
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            
            const expiryDate = new Date(expiryDateStr + 'T00:00:00');
            
            const diffTime = expiryDate.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { text: "Vencido", colorClasses: "bg-gray-800 text-white" };
            } else if (diffDays <= 7) {
                return { text: "Por vencer en 1 semana", colorClasses: "bg-[#FECACA] text-red-800" };
            } else if (diffDays <= 30) {
                return { text: "Por vencer en 1 mes", colorClasses: "bg-[#FEF08A] text-yellow-800" };
            } else {
                return { text: `Vence en ${diffDays} días`, colorClasses: "bg-[#D1FAE5] text-green-800" };
            }
        }

        function renderProducts(products) {
            productList.innerHTML = '';
            if (products.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                products.forEach(product => {
                    const status = calculateStatus(product.expiryDate);
                    const formattedDate = new Date(product.expiryDate + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

                    const card = document.createElement('div');
                    card.className = 'product-card bg-white p-4 rounded-2xl shadow-md flex items-center justify-between';
                    
                    card.innerHTML = `
                        <div>
                            <p class="text-xl font-semibold text-gray-800">${product.name}</p>
                            <p class="text-sm text-gray-500">Vence: ${formattedDate}</p>
                            <span class="mt-2 inline-block px-3 py-1 text-sm font-semibold rounded-full ${status.colorClasses}">${status.text}</span>
                        </div>
                        <button data-id="${product.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    productList.appendChild(card);
                });
            }
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = productNameInput.value;
            const expiryDate = expiryDateInput.value;

            if (!name || !expiryDate || !productsCollectionRef) {
                return;
            }

            try {
                await addDoc(productsCollectionRef, {
                    name: name,
                    expiryDate: expiryDate
                });
                productForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });
        
        productList.addEventListener('click', async (e) => {
            if (e.target && e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                const docId = button.dataset.id;
                if (docId) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/products`, docId));
                    } catch (error) {
                        console.error("Error removing document: ", error);
                    }
                }
            }
        });

        // Toggle between login and register forms
        toggleRegisterBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            toggleRegisterBtn.classList.add('hidden');
            registerForm.classList.remove('hidden');
            toggleLoginBtn.classList.remove('hidden');
        });

        toggleLoginBtn.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            toggleLoginBtn.classList.add('hidden');
            loginForm.classList.remove('hidden');
            toggleRegisterBtn.classList.remove('hidden');
        });

        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.querySelector('input[type="email"]').value;
            const password = e.target.querySelector('input[type="password"]').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                alert("Error al iniciar sesión. Por favor, verifica tu correo y contraseña.");
            }
        });

        // Handle register form submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.querySelector('input[type="email"]').value;
            const password = e.target.querySelector('input[type="password"]').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Registration failed:", error);
                alert("Error al registrarte. La contraseña debe tener al menos 6 caracteres y el correo ser válido.");
            }
        });

        initializeAuth();
    </script>
</body>
</html>
